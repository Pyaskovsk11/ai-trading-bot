# Техническое задание для реализации BingXExchangeService

## Общее описание

`BingXExchangeService` - это класс, который обеспечивает взаимодействие с API биржи BingX. Он должен поддерживать работу как с демо-счетом, так и с реальным счетом, и предоставлять методы для выполнения основных торговых операций.

## Структура класса

```python
class BingXExchangeService:
    def __init__(self, api_key: str = None, api_secret: str = None, is_demo: bool = True):
        # Инициализация сервиса
        pass

    def _generate_signature(self, params: Dict[str, Any]) -> str:
        # Генерация подписи для запросов к API
        pass

    def _make_request(self, method: str, endpoint: str, params: Dict[str, Any] = None) -> Dict[str, Any]:
        # Выполнение запроса к API BingX
        pass

    def get_account_balance(self) -> Dict[str, float]:
        # Получение баланса аккаунта
        pass

    def get_open_positions(self) -> List[Dict[str, Any]]:
        # Получение открытых позиций
        pass

    def place_market_order(self, symbol: str, side: str, quantity: float) -> Dict[str, Any]:
        # Размещение рыночного ордера
        pass

    def place_limit_order(self, symbol: str, side: str, quantity: float, price: float) -> Dict[str, Any]:
        # Размещение лимитного ордера
        pass

    def cancel_order(self, symbol: str, order_id: str) -> Dict[str, Any]:
        # Отмена ордера
        pass

    def get_order_status(self, symbol: str, order_id: str) -> Dict[str, Any]:
        # Получение статуса ордера
        pass

    def get_order_history(self, symbol: str = None, limit: int = 50) -> List[Dict[str, Any]]:
        # Получение истории ордеров
        pass

    def execute_signal_trade(self, signal: Signal, risk_percentage: float = 1.0) -> Optional[Trade]:
        # Выполнение торговли на основе сигнала
        pass
```

## Детальные требования к методам

### 1. `__init__`

- **Параметры**:
  - `api_key`: API ключ BingX (если None, берется из настроек)
  - `api_secret`: API секрет BingX (если None, берется из настроек)
  - `is_demo`: Использовать демо-счет (True) или реальный счет (False)
- **Действия**:
  - Инициализировать атрибуты класса
  - Выбрать базовый URL API в зависимости от типа счета (демо или реальный)
  - Настроить логирование

### 2. `_generate_signature`

- **Параметры**:
  - `params`: Параметры запроса
- **Действия**:
  - Отсортировать параметры по ключам
  - Создать строку запроса в формате `key1=value1&key2=value2`
  - Сгенерировать HMAC-SHA256 подпись с использованием API секрета
  - Вернуть подпись в виде строки

### 3. `_make_request`

- **Параметры**:
  - `method`: HTTP метод (GET, POST, DELETE)
  - `endpoint`: Эндпоинт API
  - `params`: Параметры запроса
- **Действия**:
  - Добавить timestamp и recvWindow к параметрам
  - Сгенерировать подпись и добавить ее к параметрам
  - Добавить API ключ в заголовки
  - Выполнить запрос с повторными попытками при ошибках
  - Обработать ответ и вернуть результат

### 4. `get_account_balance`

- **Параметры**: Нет
- **Действия**:
  - Выполнить GET запрос к эндпоинту `/api/v1/account`
  - Обработать ответ и вернуть словарь с балансами по валютам

### 5. `get_open_positions`

- **Параметры**: Нет
- **Действия**:
  - Выполнить GET запрос к эндпоинту `/api/v1/openPositions`
  - Обработать ответ и вернуть список открытых позиций

### 6. `place_market_order`

- **Параметры**:
  - `symbol`: Символ торговой пары (например, "BTCUSDT")
  - `side`: Сторона ордера ("BUY" или "SELL")
  - `quantity`: Количество для покупки/продажи
- **Действия**:
  - Выполнить POST запрос к эндпоинту `/api/v1/order`
  - Передать параметры: symbol, side, type=MARKET, quantity
  - Обработать ответ и вернуть информацию о размещенном ордере

### 7. `place_limit_order`

- **Параметры**:
  - `symbol`: Символ торговой пары
  - `side`: Сторона ордера
  - `quantity`: Количество
  - `price`: Цена ордера
- **Действия**:
  - Выполнить POST запрос к эндпоинту `/api/v1/order`
  - Передать параметры: symbol, side, type=LIMIT, timeInForce=GTC, quantity, price
  - Обработать ответ и вернуть информацию о размещенном ордере

### 8. `cancel_order`

- **Параметры**:
  - `symbol`: Символ торговой пары
  - `order_id`: ID ордера для отмены
- **Действия**:
  - Выполнить DELETE запрос к эндпоинту `/api/v1/order`
  - Передать параметры: symbol, orderId
  - Обработать ответ и вернуть информацию об отмененном ордере

### 9. `get_order_status`

- **Параметры**:
  - `symbol`: Символ торговой пары
  - `order_id`: ID ордера
- **Действия**:
  - Выполнить GET запрос к эндпоинту `/api/v1/order`
  - Передать параметры: symbol, orderId
  - Обработать ответ и вернуть информацию о статусе ордера

### 10. `get_order_history`

- **Параметры**:
  - `symbol`: Символ торговой пары (опционально)
  - `limit`: Максимальное количество ордеров для получения
- **Действия**:
  - Выполнить GET запрос к эндпоинту `/api/v1/allOrders`
  - Передать параметры: limit, symbol (если указан)
  - Обработать ответ и вернуть список ордеров

### 11. `execute_signal_trade`

- **Параметры**:
  - `signal`: Объект сигнала
  - `risk_percentage`: Процент от доступного баланса для риска
- **Действия**:
  - Получить баланс аккаунта
  - Рассчитать размер позиции на основе риска
  - Преобразовать пару активов в формат биржи
  - Определить сторону ордера
  - Разместить рыночный ордер
  - Создать и вернуть объект сделки

## Особенности реализации

### 1. Аутентификация и подпись запросов

BingX API требует подписи запросов с использованием HMAC-SHA256. Процесс следующий:

1. Создать строку запроса из всех параметров, отсортированных по ключам
2. Подписать строку запроса с использованием API секрета
3. Добавить подпись к параметрам запроса
4. Добавить API ключ в заголовки запроса

### 2. Обработка ошибок и повторные попытки

Реализовать механизм повторных попыток при ошибках:

1. Определить максимальное количество попыток (например, 3)
2. Использовать экспоненциальную задержку между попытками
3. Логировать ошибки и повторные попытки
4. Обрабатывать различные типы ошибок (сетевые, API, аутентификации)

### 3. Логирование

Реализовать подробное логирование всех операций:

1. Логировать начало и завершение каждого метода
2. Логировать параметры запросов (без секретных данных)
3. Логировать ответы API (без чувствительной информации)
4. Логировать ошибки и исключения

## Рекомендации по тестированию

### 1. Модульные тесты

Создать модульные тесты для каждого метода:

1. Тесты для генерации подписи
2. Тесты для выполнения запросов с моками
3. Тесты для обработки ошибок и повторных попыток

### 2. Интеграционные тесты

Создать интеграционные тесты с использованием демо-счета:

1. Тест получения баланса
2. Тест размещения и отмены ордеров
3. Тест получения истории ордеров

### 3. Ручное тестирование

Провести ручное тестирование с использованием демо-счета:

1. Проверить получение баланса
2. Проверить размещение рыночного ордера
3. Проверить размещение и отмену лимитного ордера
4. Проверить получение статуса ордера и истории ордеров

## Примеры использования

### Пример 1: Получение баланса

```python
from app.services.exchange_service import BingXExchangeService

# Создание сервиса
exchange_service = BingXExchangeService(is_demo=True)

# Получение баланса
balances = exchange_service.get_account_balance()
print(f"USDT Balance: {balances.get('USDT', 0)}")
```

### Пример 2: Размещение рыночного ордера

```python
from app.services.exchange_service import BingXExchangeService

# Создание сервиса
exchange_service = BingXExchangeService(is_demo=True)

# Размещение рыночного ордера
order = exchange_service.place_market_order(
    symbol="BTCUSDT",
    side="BUY",
    quantity=0.001
)
print(f"Order ID: {order.get('orderId')}")
```

### Пример 3: Выполнение торговли на основе сигнала

```python
from app.services.exchange_service import BingXExchangeService
from app.db.models import Signal

# Создание сервиса
exchange_service = BingXExchangeService(is_demo=True)

# Создание сигнала
signal = Signal(
    id=1,
    asset_pair="BTC/USDT",
    signal_type="BUY",
    price_at_signal=50000.0,
    target_price=55000.0,
    stop_loss=48000.0,
    confidence_score=0.8,
    status="ACTIVE"
)

# Выполнение торговли
trade = exchange_service.execute_signal_trade(signal, risk_percentage=0.5)
if trade:
    print(f"Trade executed: {trade.entry_price} x {trade.volume}")
else:
    print("Failed to execute trade")
```

## Дополнительные рекомендации

1. **Безопасность**:

   - Не хранить API ключи в коде
   - Использовать переменные окружения или защищенное хранилище секретов
   - Ограничить доступ к API ключам

2. **Производительность**:

   - Использовать асинхронные запросы для повышения производительности
   - Кэшировать часто используемые данные
   - Оптимизировать количество запросов к API

3. **Масштабируемость**:
   - Проектировать сервис с учетом возможности добавления новых бирж
   - Использовать абстракции для общих операций
   - Разделять ответственность между классами
