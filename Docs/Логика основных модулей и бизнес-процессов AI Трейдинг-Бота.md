## Логика основных модулей и бизнес-процессов AI Трейдинг-Бота

Этот документ описывает внутреннюю логику ключевых модулей и основные бизнес-процессы AI трейдинг-бота, как указано в первоначальной документации и с учетом "Cursor Project Rules".

### 1. Общий бизнес-процесс (от сбора данных до сигнала)

Основной цикл работы бота можно представить следующей последовательностью шагов, многие из которых автоматизированы с помощью планировщика (`scheduler.py`):

1.  **Сбор данных (по расписанию)**: `scheduler.py` инициирует регулярный сбор данных:
    *   **Цены**: Получение актуальных котировок (OHLCV) с биржи BingX для отслеживаемых активов (BTC/ETH, затем топ-25 по волатильности).
    *   **Новости**: Сбор новостей и их передача в Hector RAG для анализа.
    *   **Smart Money**: Сбор данных об активности крупных игроков с платформ Arkham и Lookonchain.
2.  **Обработка и хранение данных**: Собранные данные предварительно обрабатываются и сохраняются в соответствующие таблицы базы данных PostgreSQL (`news_articles`, возможно, временное хранилище для цен и событий Smart Money).
3.  **Анализ данных (по расписанию или по событию)**:
    *   **Технический анализ (ТА)**: На основе свежих ценовых данных рассчитываются индикаторы (RSI, MACD, EMA) и определяются свечные модели.
    *   **RAG-анализ новостей**: Результаты анализа новостей от Hector RAG (затронутые активы, тональность, ранжирование) обрабатываются и сохраняются.
    *   **Анализ Smart Money**: Данные о действиях крупных игроков анализируются на предмет значимых событий.
4.  **Формирование торгового сигнала**: Основной сервис принятия решений комбинирует результаты ТА, анализа новостей и Smart Money. Если условия для входа в сделку совпадают, генерируется предварительный сигнал.
5.  **Управление рисками**: К предварительному сигналу применяются правила риск-менеджмента (процент от капитала на сделку, максимальные потери, определение стоп-лосса).
6.  **Генерация XAI-объяснения**: Для подтвержденного и прошедшего риск-контроль сигнала генерируется текстовое объяснение его причин.
7.  **Сохранение и распространение сигнала**: Финальный сигнал со всеми параметрами и объяснением сохраняется в БД (`signals`, `xai_explanations`). Информация о сигнале становится доступной через API для Telegram-бота и веб-интерфейса.
8.  **Логирование сделки (симуляция)**: Информация о сигнале также может логироваться в таблицу `trades` для отслеживания его эффективности (симуляция сделки).

### 2. Детализация логики ключевых модулей

Логика этих модулей будет преимущественно располагаться в директории `app/services/` для бизнес-логики и `app/utils/` для вспомогательных функций, в соответствии с "Cursor Project Rules".

#### 2.1. Сервис сбора данных (`app/services/data_collection_service.py`)

Отвечает за получение данных из внешних источников.

*   **Сбор ценовых данных (BingX)**:
    *   **Источник**: API биржи BingX.
    *   **Частота**: Настраиваемая (например, каждые 1, 5, 15 минут для разных таймфреймов).
    *   **Данные**: OHLCV (Open, High, Low, Close, Volume) для выбранных активов.
    *   **Хранение**: Данные могут временно кэшироваться или напрямую передаваться в модули анализа. Ключевые ценовые точки (цена на момент сигнала) будут сохраняться в таблицах `signals` или `trades`.
    *   **Инициация**: Запускается через `scheduler.py`.
*   **Сбор и обработка новостей (Hector RAG)**:
    *   **Источник**: Hector RAG (который, в свою очередь, агрегирует новости из различных источников).
    *   **Частота**: Настраиваемая (например, каждые 5-15 минут).
    *   **Обработка**: Интеграция с Hector RAG для получения структурированного вывода: затронутые активы, оценка тональности, краткое содержание.
    *   **Хранение**: Результаты сохраняются в таблицу `news_articles`.
    *   **Инициация**: Запускается через `scheduler.py`.
*   **Сбор данных Smart Money (Arkham, Lookonchain)**:
    *   **Источники**: API Arkham, API/данные Lookonchain.
    *   **Частота**: Настраиваемая (например, каждые 15-60 минут) или по событиям, если API поддерживают webhooks.
    *   **Данные**: Крупные транзакции, движения по кошелькам известных игроков, притоки/оттоки средств на биржи для релевантных активов.
    *   **Хранение**: Данные могут сохраняться в отдельную таблицу `smart_money_events` (не описана ранее, но может потребоваться) или агрегироваться и включаться в поле `signals.smart_money_activity` (JSONB).
    *   **Инициация**: Запускается через `scheduler.py`.

#### 2.2. Модуль технического анализа (`app/utils/indicators.py`, используется `app/services/technical_analysis_service.py`)

*   **Входные данные**: Ценовые данные (OHLCV) по активам.
*   **Индикаторы и модели (`indicators.py`)**:
    *   **RSI (Relative Strength Index)**: Расчет значения, определение зон перекупленности/перепроданности.
    *   **MACD (Moving Average Convergence Divergence)**: Расчет линии MACD, сигнальной линии, гистограммы. Определение пересечений.
    *   **EMA (Exponential Moving Average)**: Расчет экспоненциальных скользящих средних для различных периодов (например, EMA20, EMA50, EMA200). Определение пересечений и направления тренда.
    *   **Свечные модели**: Идентификация распространенных паттернов (например, Доджи, Молот, Поглощение). Могут использоваться библиотеки, такие как `TA-Lib`.
*   **Сервис анализа (`technical_analysis_service.py`)**: Оркестрирует применение функций из `indicators.py` к различным активам и таймфреймам, формирует структурированный вывод для сервиса генерации сигналов.

#### 2.3. Сервис RAG-анализа новостей (`app/services/rag_analysis_service.py`)

*   **Входные данные**: Сырые новостные данные (или триггеры от `data_collection_service.py`).
*   **Логика**: Взаимодействие с Hector RAG. Обработка ответа от RAG: извлечение затронутых активов, оценки тональности, релевантности, краткого содержания.
*   **Ранжирование**: Новости могут ранжироваться по силе тональности, релевантности к отслеживаемым активам.
*   **Выходные данные**: Структурированная информация для сохранения в `news_articles` и использования при генерации сигналов (например, для поля `signals.news_sentiment_score`).

#### 2.4. Сервис генерации сигналов (`app/services/signal_generation_service.py`)

Центральный модуль принятия решений.

*   **Входные данные**:
    *   Результаты технического анализа от `technical_analysis_service.py`.
    *   Результаты анализа новостей от `rag_analysis_service.py` (из таблицы `news_articles`).
    *   Данные Smart Money от `data_collection_service.py`.
    *   Текущие рыночные цены.
*   **Логика**: Основана на системе правил, которые определяют условия для генерации сигнала. Требуется совпадение нескольких факторов (теханализ + подтверждения от новостей/Smart Money).
    *   **Пример условий для LONG**: RSI в зоне перепроданности (<30), бычье пересечение MACD, цена выше ключевой EMA (например, EMA200), положительная тональность новостей по активу, отсутствие значительных продаж со стороны Smart Money.
    *   **Пример условий для SHORT**: RSI в зоне перекупленности (>70), медвежье пересечение MACD, цена ниже ключевой EMA, негативная тональность новостей, зафиксированы крупные переводы актива на биржи со стороны Smart Money.
*   **Выбор активов**: Изначально BTC/ETH, затем расширение до топ-25 по волатильности. Сервис должен знать, какие активы отслеживать.
*   **Выходные данные**: Предварительный объект сигнала, содержащий информацию об активе, типе сигнала (LONG/SHORT), предполагаемых точках входа, тейк-профита, стоп-лосса и факторах, повлиявших на решение.

#### 2.5. Модуль управления рисками (`app/utils/risk_management.py`, используется `app/services/risk_management_service.py`)

*   **Входные данные**: Предварительный сигнал, информация о капитале бота (или пользователя, если это предусмотрено).
*   **Логика (`risk_management.py`)**:
    *   **Расчет размера позиции**: Определяется на основе правила "% от капитала" (например, риск не более 1-2% от общего капитала на одну сделку).
    *   **Расчет/валидация стоп-лосса**: Определяется на основе волатильности (например, с использованием ATR) или ключевых технических уровней, при этом проверяется соответствие правилу "максимальные потери на сделку".
*   **Сервис управления рисками (`risk_management_service.py`)**: Применяет правила из `risk_management.py`. Если риск по сигналу превышает допустимые значения, сигнал может быть отклонен или помечен как высокорискованный.
*   **Выходные данные**: Одобренный сигнал с уточненными параметрами риска (размер позиции, стоп-лосс).

#### 2.6. Модуль XAI-объяснений (`app/utils/xai.py`, используется `app/services/xai_service.py`)

*   **Входные данные**: Подтвержденный сигнал со всеми данными, повлиявшими на его генерацию (значения индикаторов, новостные факторы, события Smart Money).
*   **Логика (`xai.py`)**: Генерация человекочитаемого текстового объяснения. Может быть реализована на основе шаблонов или простых правил.
    *   **Пример объяснения**: "Сигнал LONG по BTC/USDT сгенерирован, так как: RSI (28) указывает на перепроданность. MACD показал бычье пересечение. Обнаружена положительная новостная тональность (оценка: 0.75) относительно принятия Bitcoin. Трекер Smart Money зафиксировал накопление со стороны крупных кошельков. Рекомендуемый вход: $X, TP: $Y, SL: $Z."
*   **Сервис XAI (`xai_service.py`)**: Оркестрирует генерацию объяснения.
*   **Выходные данные**: Текстовое объяснение.
*   **Хранение**: Сохраняется в таблицу `xai_explanations`, ID объяснения связывается с сигналом в таблице `signals`.

#### 2.7. Сервис логирования и распространения сигналов (`app/services/trading_service.py`)

*   **Входные данные**: Финальный сигнал с XAI-объяснением и параметрами риска.
*   **Логика**:
    *   **Сохранение сигнала**: Запись информации о сигнале (включая `xai_explanation_id`) в таблицу `signals`.
    *   **Логирование "сделки" (симуляция)**: Запись информации о потенциальной сделке на основе сигнала в таблицу `trades` со статусом (например, `PENDING_SIMULATION` или `ACTIVE_SIMULATION`) для последующего анализа эффективности сигналов.
    *   **Подготовка данных для API**: Формирование данных о сигнале для передачи через API.
*   **Цель логирования**: Сбор данных для будущего обучения моделей и анализа эффективности стратегии.

#### 2.8. Планировщик задач (`app/utils/scheduler.py`)

*   **Технология**: Использует библиотеку типа `APScheduler` или системный `cron`.
*   **Задачи**:
    *   Регулярный запуск сервиса сбора данных (`data_collection_service.py`).
    *   Запуск аналитических задач: технический анализ, обработка новостей RAG (если не происходит немедленно после сбора).
    *   Периодический запуск цикла генерации сигналов (`signal_generation_service.py`).
    *   Возможные задачи по обслуживанию БД.

### 3. Взаимодействие с интерфейсами (Telegram, Web)

Хотя детальное проектирование API и интерфейсов — это следующий шаг, логика модулей должна предусматривать подготовку данных для них:

*   **Telegram-бот (`telegram_bot/`)**: Получает новые сигналы через API (эндпоинты в `app/api/`). Обрабатывает команды `/status`, `/signal`, `/summary`, запрашивая соответствующие данные через API.
*   **Веб-интерфейс (`webapp/`)**: Отображает сигналы, статистику, графики и XAI-объяснения, получая данные через те же API-эндпоинты.

Эта детализация логики модулей и бизнес-процессов служит основой для дальнейшей разработки и должна помочь в реализации функционала в среде Cursor IDE, обеспечивая соблюдение "чистой архитектуры" и разделение ответственности между компонентами системы.
